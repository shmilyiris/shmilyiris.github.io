<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="cJson是一个可以自动整理Json格式文件的脚本。 项目地址">
<meta property="og:type" content="article">
<meta property="og:title" content="开源项目cJson">
<meta property="og:url" content="http://yoursite.com/2020/09/07/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AEcJson/index.html">
<meta property="og:site_name" content="今天你Coding了吗?">
<meta property="og:description" content="cJson是一个可以自动整理Json格式文件的脚本。 项目地址">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img.blog.csdn.net/20161119144432000">
<meta property="article:published_time" content="2020-09-07T11:14:04.000Z">
<meta property="article:modified_time" content="2020-11-28T01:51:44.511Z">
<meta property="article:author" content="Michael Johnson">
<meta property="article:tag" content="C">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img.blog.csdn.net/20161119144432000">

<link rel="canonical" href="http://yoursite.com/2020/09/07/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AEcJson/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>开源项目cJson | 今天你Coding了吗?</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">今天你Coding了吗?</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/07/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AEcJson/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/%E7%A8%8B%E5%BA%8F%E7%8C%BF.jpg">
      <meta itemprop="name" content="Michael Johnson">
      <meta itemprop="description" content="小白的个人网站">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="今天你Coding了吗?">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          开源项目cJson
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-07 19:14:04" itemprop="dateCreated datePublished" datetime="2020-09-07T19:14:04+08:00">2020-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-28 09:51:44" itemprop="dateModified" datetime="2020-11-28T09:51:44+08:00">2020-11-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">开源项目</span></a>
                </span>
            </span>

          
            <span id="/2020/09/07/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AEcJson/" class="post-meta-item leancloud_visitors" data-flag-title="开源项目cJson" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/09/07/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AEcJson/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/09/07/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AEcJson/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>cJson是一个可以自动整理Json格式文件的脚本。</p>
<p><a href="https://sourceforge.net/projects/cjson/" target="_blank" rel="noopener">项目地址</a></p>
<a id="more"></a>

<h1 id="包含文件"><a href="#包含文件" class="headerlink" title="包含文件"></a>包含文件</h1><ul>
<li>cJSON.c</li>
<li>cJSON.h</li>
<li>test.c</li>
</ul>
<h1 id="文件内容"><a href="#文件内容" class="headerlink" title="文件内容"></a>文件内容</h1><h2 id="cJSON-h"><a href="#cJSON-h" class="headerlink" title="cJSON.h"></a>cJSON.h</h2><h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p>定义了9个宏，表示JSON格式中的全部7个数据类型加上两个额外项。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_False 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_True 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_NULL 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_Number 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_String 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_Array 5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_Object 6</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_IsReference 256</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_StringIsConst 512</span></span><br></pre></td></tr></table></figure>

<p><img src="http://img.blog.csdn.net/20161119144432000" alt="数据类型示意图"></p>
<h3 id="数据结构和其构造函数"><a href="#数据结构和其构造函数" class="headerlink" title="数据结构和其构造函数"></a>数据结构和其构造函数</h3><p>声明了JSON格式的数据结构。</p>
<ul>
<li>对于array，item-&gt;child是其本体，其中以双向链表的形式存储各个链表节点（array中的元素）</li>
<li>对于object，item-&gt;child是其存储的第一级元素（即第一个逗号前的元素）。以下类推，每个键值对可由child向下递推，其中的键是item-&gt;string。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*cJSON格式的数据结构*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">cJSON</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cJSON</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cJSON</span> *<span class="title">child</span>;</span> </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> type; <span class="comment">// 对应上面的宏定义，即数据类型</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> *valuestring;</span><br><span class="line">    <span class="keyword">int</span> valueint;</span><br><span class="line">    <span class="keyword">double</span> valuedouble;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> *<span class="built_in">string</span>; <span class="comment">// 对象的名称字符串</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">cJSON_Hooks</span> &#123;</span></span><br><span class="line">	<span class="comment">/*malloc_fn是一个函数指针，它所指向的函数有一个size_t类型的参数，返回一个void类型的指针*/</span></span><br><span class="line">    <span class="keyword">void</span> *(*malloc_fn)(<span class="keyword">size_t</span> sz);</span><br><span class="line">    <span class="comment">/*free_fn是一个函数指针，它所指向的函数具有一个void*类型的指针参数，无返回值*/</span></span><br><span class="line">    <span class="keyword">void</span> (*free_fn)(<span class="keyword">void</span> *ptr);</span><br><span class="line">&#125; cJSON_Hooks;</span><br></pre></td></tr></table></figure>

<p>将以上代码段与cJSON.c文件中的内容结合来看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*在全局声明了两个静态函数指针，分别把json_malloc和json_free指向malloc和free函数*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *(*json_malloc)(<span class="keyword">size_t</span> sz) = <span class="built_in">malloc</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">void</span> <span class="params">(*json_free)</span><span class="params">(<span class="keyword">void</span> *ptr)</span> </span>= <span class="built_in">free</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">json_init_hooks</span><span class="params">(json_hooks *hooks)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!hooks)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">// 如果hook未声明，就对两个函数指针重置</span></span><br><span class="line">        json_malloc = <span class="built_in">malloc</span>;</span><br><span class="line">        json_free = <span class="built_in">free</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 如果已声明</span></span><br><span class="line">    json_malloc = (hooks-&gt;malloc_fn)?hooks-&gt;malloc_fn:<span class="built_in">malloc</span>;</span><br><span class="line">    json_free = (hooks-&gt;free_fn)?hooks-&gt;free_fn:<span class="built_in">free</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的hook整体来看是提供了一个接口，允许开发者自定义一组<code>malloc</code>和<code>free</code>函数，如果开发者未定义，默认采用stdlib.h头文件中的<code>malloc</code>和<code>free</code>。</p>
<h3 id="函数声明"><a href="#函数声明" class="headerlink" title="函数声明"></a>函数声明</h3><h4 id="主要函数"><a href="#主要函数" class="headerlink" title="主要函数"></a>主要函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_Parse</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *value)</span></span>; <span class="comment">// 返回一个可读的JSON对象，完成时调用cJSON_Delete</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">char</span> *<span class="title">cJSON_Print</span><span class="params">(cJSON *item)</span></span>; <span class="comment">// 将cJSON输出，完成时释放char*</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">char</span> *<span class="title">cJSON_PrintUnformatted</span><span class="params">(cJSON *item)</span></span>; <span class="comment">// 输出没有经过整理的对象，完成时释放char*</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">char</span> *<span class="title">cJSON_PrintBuffered</span><span class="params">(cJSON *item, <span class="keyword">int</span> prebuffer, <span class="keyword">int</span> fmt)</span></span>; <span class="comment">// 使用缓冲策略将cJSON实体呈现给文本。预缓冲是对最终大小的猜测。猜测得好可以减少重新分配。fmt=0表示未格式化，=1表示格式化</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">cJSON_Delete</span><span class="params">(cJSON *c)</span></span>; <span class="comment">// 删除一个cJSON实体和其子体</span></span><br></pre></td></tr></table></figure>

<h4 id="辅助函数"><a href="#辅助函数" class="headerlink" title="辅助函数"></a>辅助函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">cJSON_GetArraySize</span><span class="params">(cJSON *<span class="built_in">array</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_GetArrayItem</span><span class="params">(cJSON *<span class="built_in">array</span>, <span class="keyword">int</span> item)</span></span>; <span class="comment">// 取出数组中的元素，如果不成功返回空</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_GetObjectItem</span><span class="params">(cJSON* object, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>)</span></span>; <span class="comment">// 从对象中获取字符串，不区分大小写</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">cJSON_GetErrorItem</span><span class="params">(cJSON *object, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>)</span></span>; <span class="comment">// 对于错误解析，返回一个指向这个错误解析的指针</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*create函数簇*/</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateNull</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateTrue</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateFalse</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateBool</span><span class="params">(<span class="keyword">int</span> b)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateNumber</span><span class="params">(<span class="keyword">double</span> num)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateString</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateArray</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateObject</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateIntArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> *numbers,<span class="keyword">int</span> count)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateFloatArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">float</span> *numbers,<span class="keyword">int</span> count)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateDoubleArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *numbers,<span class="keyword">int</span> count)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_CreateStringArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> **strings,<span class="keyword">int</span> count)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*add函数簇*/</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">cJSON_AddItemToArray</span><span class="params">(cJSON *<span class="built_in">array</span>, cJSON *item)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span>	<span class="title">cJSON_AddItemToObject</span><span class="params">(cJSON *object,<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>,cJSON *item)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span>	<span class="title">cJSON_AddItemToObjectCS</span><span class="params">(cJSON *object,<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>,cJSON *item)</span></span>;	<span class="comment">//当字符串必定是常量(例如，一个文字，或者和常量一样好)，并且肯定能在cJSON对象中保留</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 将对项目的引用附加到指定的数组/对象。 当您要将现有的cJSON添加到新的cJSON，但又不想破坏现有的cJSON时，请使用此选项。 */</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">cJSON_AddItemReferenceToArray</span><span class="params">(cJSON *<span class="built_in">array</span>, cJSON *item)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span>	<span class="title">cJSON_AddItemReferenceToObject</span><span class="params">(cJSON *object,<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>, cJSON *item)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_Duplicate</span><span class="params">(cJSON *item,<span class="keyword">int</span> recurse)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 允许您要求(并检查)JSON是否以null结尾，并检索到最终解析的字节的指针。</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> cJSON *<span class="title">cJSON_ParseWithOpts</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *value,<span class="keyword">const</span> <span class="keyword">char</span> **return_parse_end,<span class="keyword">int</span> require_null_terminated)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">cJSON_Minify</span><span class="params">(<span class="keyword">char</span> *json)</span></span>;</span><br></pre></td></tr></table></figure>

<p>过程是调用<code>cJSON_AddItemToObject()</code>并结合不同的对象类型增加节点名称和子节点。然后在其中调用<code>cJSON_AddItemToArray()</code>函数来添加信息，此函数中判断对象孩子结点是否为<code>NULL</code>，如果是<code>NULL</code>，则直接插入，否则找到最后一个孩子，调用<code>suffix_object()</code>函数添加到双向链表的尾部。</p>
<h3 id="宏声明"><a href="#宏声明" class="headerlink" title="宏声明"></a>宏声明</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*创造对象直接用添加函数来替代，提高效率*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_AddNullToObject(object,name)		cJSON_AddItemToObject(object, name, cJSON_CreateNull())</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_AddTrueToObject(object,name)		cJSON_AddItemToObject(object, name, cJSON_CreateTrue())</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_AddFalseToObject(object,name)		cJSON_AddItemToObject(object, name, cJSON_CreateFalse())</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_AddBoolToObject(object,name,b)	cJSON_AddItemToObject(object, name, cJSON_CreateBool(b))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_AddNumberToObject(object,name,n)	cJSON_AddItemToObject(object, name, cJSON_CreateNumber(n))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_AddStringToObject(object,name,s)	cJSON_AddItemToObject(object, name, cJSON_CreateString(s))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*创造整数数据时，也要将其拷贝到valdouble上*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_SetIntValue(object,val)			((object)?(object)-&gt;valueint=(object)-&gt;valuedouble=(val):(val))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_SetNumberValue(object,val)		((object)?(object)-&gt;valueint=(object)-&gt;valuedouble=(val):(val))</span></span><br></pre></td></tr></table></figure>



<h2 id="cJSON-c"><a href="#cJSON-c" class="headerlink" title="cJSON.c"></a>cJSON.c</h2><h3 id="解析函数"><a href="#解析函数" class="headerlink" title="解析函数"></a>解析函数</h3><h4 id="主函数"><a href="#主函数" class="headerlink" title="主函数"></a>主函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">cJSON *<span class="title">cJSON_Parse</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> cJSON_ParseWithOpts(value, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_ParseWithOpts</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *value, <span class="keyword">const</span> <span class="keyword">char</span> **return_parse_end, <span class="keyword">int</span> require_null_terminated)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">end</span> = <span class="number">0</span>;</span><br><span class="line">    cJSON *c = cJSON_New_Item();</span><br><span class="line">    ep = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!c) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">end</span> = parse_value(c, skip(value));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">end</span>) &#123;</span><br><span class="line">        cJSON_Delete(c);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (require_null_terminated) &#123;</span><br><span class="line">        <span class="built_in">end</span> = skip(<span class="built_in">end</span>);</span><br><span class="line">        <span class="keyword">if</span> (*<span class="built_in">end</span>) &#123;</span><br><span class="line">            cJSON_Delete(c);</span><br><span class="line">            ep = <span class="built_in">end</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (return_parse_end) *return_parse_end = <span class="built_in">end</span>;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*解析字符串value，并将其填充到item对象中*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">parse_value</span><span class="params">(cJSON *item, <span class="keyword">const</span> <span class="keyword">char</span> *value)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!value)						<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strncmp</span>(value,<span class="string">"null"</span>,<span class="number">4</span>))	&#123; item-&gt;type = cJSON_NULL;  <span class="keyword">return</span> value + <span class="number">4</span>; &#125;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strncmp</span>(value,<span class="string">"false"</span>,<span class="number">5</span>))	&#123; item-&gt;type = cJSON_False; <span class="keyword">return</span> value + <span class="number">5</span>; &#125;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strncmp</span>(value,<span class="string">"true"</span>,<span class="number">4</span>))	&#123; item-&gt;type = cJSON_True; item-&gt;valueint = <span class="number">1</span>;	<span class="keyword">return</span> value + <span class="number">4</span>; &#125;</span><br><span class="line">	<span class="keyword">if</span> (*value == <span class="string">'\"'</span>)				&#123; <span class="keyword">return</span> parse_string(item,value); &#125;</span><br><span class="line">	<span class="keyword">if</span> (*value == <span class="string">'-'</span> || (*value &gt;= <span class="string">'0'</span> &amp;&amp; *value &lt;= <span class="string">'9'</span>))	&#123; <span class="keyword">return</span> parse_number(item,value); &#125;</span><br><span class="line">	<span class="keyword">if</span> (*value == <span class="string">'['</span>)				&#123; <span class="keyword">return</span> parse_array(item,value); &#125;</span><br><span class="line">	<span class="keyword">if</span> (*value == <span class="string">'&#123;'</span>)				&#123; <span class="keyword">return</span> parse_object(item,value); &#125;</span><br><span class="line"></span><br><span class="line">	ep = value;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 失败，返回0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意其中的<code>skip()</code>函数（跳过空格等）为自定义的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">skip</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *in)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// in != NULL &amp;&amp; *in != \0 &amp;&amp; 不是控制字符</span></span><br><span class="line">    <span class="keyword">while</span> (in &amp;&amp; *in &amp;&amp; (<span class="keyword">unsigned</span> <span class="keyword">char</span>)*in &lt;= <span class="number">32</span>)</span><br><span class="line">        in++;</span><br><span class="line">    <span class="keyword">return</span> in;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分函数"><a href="#分函数" class="headerlink" title="分函数"></a>分函数</h4><h5 id="parse-hex4-函数"><a href="#parse-hex4-函数" class="headerlink" title="parse_hex4()函数"></a><code>parse_hex4()</code>函数</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 从str开始截取4位十六进制转换成数字返回 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="title">parse_hex4</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> h = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (*str &gt;= <span class="string">'0'</span> &amp;&amp; *str &lt;= <span class="string">'9'</span>) h += (*str) - <span class="string">'0'</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*str &gt;= <span class="string">'A'</span> &amp;&amp; *str &lt;= <span class="string">'F'</span>) h += <span class="number">10</span> + (*str) - <span class="string">'A'</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*str &gt;= <span class="string">'a'</span> &amp;&amp; *str &lt;= <span class="string">'f'</span>) h += <span class="number">10</span> + (*str) - <span class="string">'a'</span>; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    h &lt;&lt;= <span class="number">4</span>; str++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*str &gt;= <span class="string">'0'</span> &amp;&amp; *str &lt;= <span class="string">'9'</span>) h += (*str) - <span class="string">'0'</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*str &gt;= <span class="string">'A'</span> &amp;&amp; *str &lt;= <span class="string">'F'</span>) h += <span class="number">10</span> + (*str) - <span class="string">'A'</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*str &gt;= <span class="string">'a'</span> &amp;&amp; *str &lt;= <span class="string">'f'</span>) h += <span class="number">10</span> + (*str) - <span class="string">'a'</span>; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    h &lt;&lt;= <span class="number">4</span>; str++;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*str &gt;= <span class="string">'0'</span> &amp;&amp; *str &lt;= <span class="string">'9'</span>) h += (*str) - <span class="string">'0'</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*str &gt;= <span class="string">'A'</span> &amp;&amp; *str &lt;= <span class="string">'F'</span>) h += <span class="number">10</span> + (*str) - <span class="string">'A'</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*str &gt;= <span class="string">'a'</span> &amp;&amp; *str &lt;= <span class="string">'f'</span>) h += <span class="number">10</span> + (*str) - <span class="string">'a'</span>; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    h &lt;&lt;= <span class="number">4</span>; str++;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*str &gt;= <span class="string">'0'</span> &amp;&amp; *str &lt;= <span class="string">'9'</span>) h += (*str) - <span class="string">'0'</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*str &gt;= <span class="string">'A'</span> &amp;&amp; *str &lt;= <span class="string">'F'</span>) h += <span class="number">10</span> + (*str) - <span class="string">'A'</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*str &gt;= <span class="string">'a'</span> &amp;&amp; *str &lt;= <span class="string">'f'</span>) h += <span class="number">10</span> + (*str) - <span class="string">'a'</span>; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="parse-number"><a href="#parse-number" class="headerlink" title="parse_number()"></a><code>parse_number()</code></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 将输入文本解析成数字，并把解析的结果填充到对象中 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">parse_number</span><span class="params">(cJSON *item, <span class="keyword">const</span> <span class="keyword">char</span> *num)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// sign标记了数字符号</span></span><br><span class="line">    <span class="keyword">double</span> n = <span class="number">0</span>, sign = <span class="number">1</span>, scale = <span class="number">0</span>; <span class="comment">// 底数部分</span></span><br><span class="line">    <span class="keyword">int</span> subscale = <span class="number">0</span>, signsubscale = <span class="number">1</span>; <span class="comment">// 指数部分</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*num == <span class="string">'-'</span>) sign = <span class="number">-1</span>, num++;</span><br><span class="line">    <span class="keyword">if</span> (*num == <span class="string">'0'</span>) num++;</span><br><span class="line">    <span class="keyword">if</span> (*num &gt;= <span class="string">'1'</span> &amp;&amp; *num &lt;= <span class="string">'9'</span>) &#123;</span><br><span class="line">        <span class="comment">// 字符串转数字</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            n = (n * <span class="number">10.0</span>) + (*num++ - <span class="string">'0'</span>);</span><br><span class="line">        &#125; <span class="keyword">while</span> (*num &gt;= <span class="string">'0'</span> &amp;&amp; *num &lt;= <span class="string">'9'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*num == <span class="string">'e'</span> || *num == <span class="string">'E'</span>) &#123;</span><br><span class="line">        num++;</span><br><span class="line">        <span class="keyword">if</span> (*num == <span class="string">'+'</span>) num++;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (*num == <span class="string">'-'</span>) signsubscale = <span class="number">-1</span>, num++;</span><br><span class="line">        <span class="keyword">while</span> (*num &gt;= <span class="string">'0'</span> &amp;&amp; *num &lt;= <span class="string">'9'</span>)</span><br><span class="line">            subscale = (subscale * <span class="number">10</span>) + (*num++ - <span class="string">'0'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    n = sign * n * <span class="built_in">pow</span>(<span class="number">10.0</span>, (scale + subscale * signsubscale));</span><br><span class="line">    </span><br><span class="line">    item-&gt;valuedouble = n;</span><br><span class="line">    item-&gt;valueint = (<span class="keyword">int</span>)n;</span><br><span class="line">    item-&gt;type = cJSON_Number; <span class="comment">// 数字类型</span></span><br><span class="line">    <span class="keyword">return</span> num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="parse-string-函数"><a href="#parse-string-函数" class="headerlink" title="parse_string()函数"></a><code>parse_string()</code>函数</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 将输入的文本解析为一个不含转义字符的string格式，并将其填充到item的valuestring中 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">parse_string</span><span class="params">(cJSON* item, <span class="keyword">const</span> <span class="keyword">char</span> *str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ptr = str + <span class="number">1</span>; <span class="comment">// ptr为string的指针</span></span><br><span class="line">    <span class="keyword">char</span>* ptr2, *out; <span class="comment">// ptr2为out的cur指针</span></span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> uc, uc2;</span><br><span class="line">    <span class="keyword">if</span> (*str != <span class="string">'\"'</span>) &#123;</span><br><span class="line">        <span class="comment">// 首先判断起始字符是否为" 若否则不是字符串</span></span><br><span class="line">        ep = str;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*获取中间的长度"xxxx" --- 长度不算\*/</span></span><br><span class="line">    <span class="keyword">while</span> (*ptr != <span class="string">'\"'</span> &amp;&amp; *ptr &amp;&amp; ++len) &#123;</span><br><span class="line">        <span class="keyword">if</span> (*ptr++ == <span class="string">'\\'</span>) ptr++; <span class="comment">// 跳过一个\</span></span><br><span class="line">    &#125;</span><br><span class="line">    out = (<span class="keyword">char</span>*)cJSON_malloc(len + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!out) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ptr = str + <span class="number">1</span>;</span><br><span class="line">    ptr2 = out;</span><br><span class="line">    <span class="keyword">while</span> (*ptr != <span class="string">'\"'</span> &amp;&amp; *ptr) &#123;</span><br><span class="line">        <span class="keyword">if</span> (*ptr != <span class="string">'\\'</span>) *ptr2++ = *ptr++;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 额外处理转义字符</span></span><br><span class="line">            ptr++;</span><br><span class="line">            <span class="keyword">switch</span> (*ptr) &#123;</span><br><span class="line">            	<span class="keyword">case</span> <span class="string">'b'</span> : *ptr2++ = <span class="string">'\b'</span>; <span class="keyword">break</span>;</span><br><span class="line">            	<span class="keyword">case</span> <span class="string">'f'</span> : *ptr2++ = <span class="string">'\f'</span>; <span class="keyword">break</span>;</span><br><span class="line">            	<span class="keyword">case</span> <span class="string">'n'</span> : *ptr2++ = <span class="string">'\n'</span>; <span class="keyword">break</span>;</span><br><span class="line">            	<span class="keyword">case</span> <span class="string">'r'</span> : *ptr2++ = <span class="string">'\r'</span>; <span class="keyword">break</span>;</span><br><span class="line">            	<span class="keyword">case</span> <span class="string">'t'</span> : *ptr2++ = <span class="string">'\t'</span>; <span class="keyword">break</span>;</span><br><span class="line">            	<span class="keyword">case</span> <span class="string">'u'</span> : <span class="comment">/*utf16 - utf8*/</span></span><br><span class="line">                    uc = parse_hex4(ptr + <span class="number">1</span>);</span><br><span class="line">                    ptr += <span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">if</span> ((uc &gt;= <span class="number">0xDC00</span> &amp;&amp; uc &lt;= <span class="number">0xDFFF</span>) || uc == <span class="number">0</span>) <span class="keyword">break</span>; <span class="comment">// 不合法的utf编码</span></span><br><span class="line">                    <span class="keyword">if</span> (uc &gt;= <span class="number">0xD800</span> &amp;&amp; uc &lt;= <span class="number">0xDBFF</span>) &#123;</span><br><span class="line">                        <span class="comment">// 采用四个字节(两个UTF-16编码)来表示一个字符</span></span><br><span class="line">                        <span class="keyword">if</span> (ptr[<span class="number">1</span>] != <span class="string">'\\'</span> || ptr[<span class="number">2</span>] != <span class="string">'u'</span>) <span class="keyword">break</span>;</span><br><span class="line">                        uc2 = parse_hex4(ptr + <span class="number">3</span>);</span><br><span class="line">                        ptr += <span class="number">6</span>;</span><br><span class="line">                        <span class="keyword">if</span> (uc2 &lt; <span class="number">0xDC00</span> || uc2 &gt; <span class="number">0xDFFF</span>) <span class="keyword">break</span>;</span><br><span class="line">                        uc = <span class="number">0x10000</span> + (((uc&amp;<span class="number">0x3FF</span>)&lt;&lt;<span class="number">10</span>) | (uc2&amp;<span class="number">0x3FF</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    len = <span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">if</span> (uc &lt; <span class="number">0x80</span>) len = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (uc &lt; <span class="number">0x800</span>) len = <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (uc &lt; <span class="number">0x10000</span>) len = <span class="number">3</span>; </span><br><span class="line">                    ptr2 += len;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">switch</span> (len) &#123;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">4</span>: *--ptr2 =((uc | <span class="number">0x80</span>) &amp; <span class="number">0xBF</span>); uc &gt;&gt;= <span class="number">6</span>;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">3</span>: *--ptr2 =((uc | <span class="number">0x80</span>) &amp; <span class="number">0xBF</span>); uc &gt;&gt;= <span class="number">6</span>;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">2</span>: *--ptr2 =((uc | <span class="number">0x80</span>) &amp; <span class="number">0xBF</span>); uc &gt;&gt;= <span class="number">6</span>;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">1</span>: *--ptr2 =(uc | firstByteMark[len]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    ptr2 += len;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>: *ptr2++ = *ptr; <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ptr++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *ptr2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (*ptr == <span class="string">'\"'</span>) ptr++;</span><br><span class="line">    item-&gt;valuestring = out;</span><br><span class="line">    item-&gt;type = cJSON_String;</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="parse-object-函数"><a href="#parse-object-函数" class="headerlink" title="parse_object()函数"></a><code>parse_object()</code>函数</h5><p>解析时，只关注元素的值，所以要反复调用<code>skip()</code>函数来跳过spacing.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">parse_object</span><span class="params">(cJson *item, <span class="keyword">const</span> <span class="keyword">char</span> *value)</span> </span>&#123;</span><br><span class="line">	cJSON* child;</span><br><span class="line">    <span class="keyword">if</span> (*value != <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">        <span class="comment">// 不是一个对象</span></span><br><span class="line">        ep = value;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    item-&gt;type = cJSON_Object;</span><br><span class="line">    value = skip(value + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (*value == <span class="string">'&#125;'</span>) <span class="keyword">return</span> value + <span class="number">1</span>; <span class="comment">// 空对象</span></span><br><span class="line">    </span><br><span class="line">    item-&gt;child = child = cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span> (!item-&gt;child) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    value = skip(parse_string(child, skip(value)));</span><br><span class="line">    <span class="keyword">if</span> (!value) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    child-&gt;<span class="built_in">string</span> = child-&gt;valuestring;</span><br><span class="line">    child-&gt;valuestring = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (*value != <span class="string">':'</span>) &#123; <span class="comment">// 解析失败</span></span><br><span class="line">        ep = value;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    value = skip(parse_value(child, skip(value + <span class="number">1</span>) <span class="comment">/*跳过:*/</span>));</span><br><span class="line">    <span class="keyword">if</span> (!value) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (*value == <span class="string">','</span>) &#123;</span><br><span class="line">        cJSON *new_item;</span><br><span class="line">        <span class="keyword">if</span> (!(new_item = cJSON_New_Item())) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 内存申请失败</span></span><br><span class="line">        child-&gt;next = new_item;</span><br><span class="line">        new_item-&gt;prev = child;</span><br><span class="line">        child = new_item;</span><br><span class="line">        </span><br><span class="line">        value = skip(parse_string(child, skip(value + <span class="number">1</span>)));</span><br><span class="line">        <span class="keyword">if</span> (!value) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        child-&gt;<span class="built_in">string</span> = child-&gt;valuestring;</span><br><span class="line">        child-&gt;valuestring = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (*value != <span class="string">':'</span>) &#123;</span><br><span class="line">            ep = value;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        value = skip(parse_value(child, skip(value + <span class="number">1</span>)));</span><br><span class="line">        <span class="keyword">if</span> (!value) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*value == <span class="string">'&#125;'</span>) <span class="keyword">return</span> value + <span class="number">1</span>;</span><br><span class="line">    ep = value;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="输出函数"><a href="#输出函数" class="headerlink" title="输出函数"></a>输出函数</h3><h4 id="总函数"><a href="#总函数" class="headerlink" title="总函数"></a>总函数</h4><p>二次封装函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">cJSON_Print</span><span class="params">(cJSOn *item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> print_value(item, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">cJSON_PrintUnformatted</span><span class="params">(cJSON *item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> print_value(item, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">cJSON_PrintBuffered</span><span class="params">(cJSON *item, <span class="keyword">int</span> prebuffer, <span class="keyword">int</span> fmt)</span> </span>&#123;</span><br><span class="line">    printbuffer p;</span><br><span class="line">    p.<span class="built_in">buffer</span> = (<span class="keyword">char</span>*)cJSON_malloc(prebuffer);</span><br><span class="line">    p.length = prebuffer;</span><br><span class="line">    p.offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> print_value(item, <span class="number">0</span>, fmt, &amp;p);</span><br><span class="line">    <span class="keyword">return</span> p.<span class="built_in">buffer</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内层函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">print_value</span><span class="params">(cJSON *item, <span class="keyword">int</span> depth, <span class="keyword">int</span> fmt, printbuffer *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *out = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!item) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (p) &#123;</span><br><span class="line">        <span class="keyword">switch</span> ((item-&gt;type) &amp; <span class="number">255</span>) &#123; <span class="comment">// 与255相与运算得到类型</span></span><br><span class="line">            <span class="comment">// 前三种情况直接输出对应的字符串</span></span><br><span class="line">			<span class="keyword">case</span> cJSON_NULL:	&#123;out=ensure(p,<span class="number">5</span>);	<span class="keyword">if</span> (out) <span class="built_in">strcpy</span>(out,<span class="string">"null"</span>);	<span class="keyword">break</span>;&#125;</span><br><span class="line">			<span class="keyword">case</span> cJSON_False:	&#123;out=ensure(p,<span class="number">6</span>);	<span class="keyword">if</span> (out) <span class="built_in">strcpy</span>(out,<span class="string">"false"</span>);	<span class="keyword">break</span>;&#125;</span><br><span class="line">			<span class="keyword">case</span> cJSON_True:	&#123;out=ensure(p,<span class="number">5</span>);	<span class="keyword">if</span> (out) <span class="built_in">strcpy</span>(out,<span class="string">"true"</span>);	<span class="keyword">break</span>;&#125;</span><br><span class="line">            <span class="comment">// 以下不同的输出分类讨论</span></span><br><span class="line">			<span class="keyword">case</span> cJSON_Number:	out=print_number(item,p);<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> cJSON_String:	out=print_string(item,p);<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> cJSON_Array:	out=print_array(item,depth,fmt,p);<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> cJSON_Object:	out=print_object(item,depth,fmt,p);<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 与缓冲区内没有数据时的区别仅为传参的起始指针由p-&gt;0</span></span><br><span class="line">        <span class="keyword">switch</span> ((item-&gt;type) &amp; <span class="number">255</span>) &#123;</span><br><span class="line">			<span class="keyword">case</span> cJSON_NULL:	out=cJSON_strdup(<span class="string">"null"</span>);	<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> cJSON_False:	out=cJSON_strdup(<span class="string">"false"</span>);<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> cJSON_True:	out=cJSON_strdup(<span class="string">"true"</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> cJSON_Number:	out=print_number(item,<span class="number">0</span>);<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> cJSON_String:	out=print_string(item,<span class="number">0</span>);<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> cJSON_Array:	out=print_array(item,depth,fmt,<span class="number">0</span>);<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> cJSON_Object:	out=print_object(item,depth,fmt,<span class="number">0</span>);<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="分函数-1"><a href="#分函数-1" class="headerlink" title="分函数"></a>分函数</h4><h5 id="print-number-函数"><a href="#print-number-函数" class="headerlink" title="print_number()函数"></a><code>print_number()</code>函数</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">print_number</span><span class="params">(cJSON *item, printbuffer *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *str = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">double</span> d = item-&gt;valuedouble; <span class="comment">// d承接对象的valuedouble</span></span><br><span class="line">    <span class="keyword">if</span> (d == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p) str = ensure(p, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">else</span> str = (<span class="keyword">char</span>*)cJSON_malloc(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (str) <span class="built_in">strcpy</span>(str, <span class="string">"0"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">fabs</span>(((<span class="keyword">double</span>)item-&gt;valuedouble) &lt;= DBL_EPSILON) &amp;&amp; d &lt;= INT_MAX &amp;&amp; d &gt;= INT_MIN) &#123;</span><br><span class="line">        <span class="comment">// DBL_EPSILON可以理解为一个极小量</span></span><br><span class="line">        <span class="keyword">if</span> (p) str = ensure(p, <span class="number">21</span>); <span class="comment">// 2^64+1（64bit计算机的极限数）可以用21个字符表示</span></span><br><span class="line">        <span class="keyword">else</span> str = (<span class="keyword">char</span>*)cJSON_malloc(<span class="number">21</span>);</span><br><span class="line">        <span class="keyword">if</span> (str) <span class="built_in">sprintf</span>(str, <span class="string">"%d"</span>, item-&gt;valueint);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (p) str = ensure(p, <span class="number">64</span>);</span><br><span class="line">        <span class="keyword">else</span> str = (<span class="keyword">char</span>*)cJSON_malloc(<span class="number">64</span>);</span><br><span class="line">        <span class="keyword">if</span> (str) &#123;</span><br><span class="line">            <span class="comment">// floor(d)求解不大于d的最大整数</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">fabs</span>(<span class="built_in">floor</span>(d) - d) &lt;= DBL_EPSILON &amp;&amp; <span class="built_in">fabs</span>(d) &lt; <span class="number">1.0e60</span>)</span><br><span class="line">                <span class="built_in">sprintf</span>(str, <span class="string">"%.0f"</span>, d); <span class="comment">// 小数位过多，保留整数位输出即可</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">fabs</span>(d) &lt; <span class="number">1.0e-6</span> || <span class="built_in">fabs</span>(d) &gt; <span class="number">1.0e9</span>)			</span><br><span class="line">                <span class="built_in">sprintf</span>(str, <span class="string">"%e"</span>, d); <span class="comment">// 如果数据过小或过大，以指数形式输出</span></span><br><span class="line">			<span class="keyword">else</span>												</span><br><span class="line">                <span class="built_in">sprintf</span>(str, <span class="string">"%f"</span>, d); <span class="comment">// 正常输出</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="print-string-函数"><a href="#print-string-函数" class="headerlink" title="print_string()函数"></a><code>print_string()</code>函数</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">print_string</span><span class="params">(cJSON *item, printbuffer *p)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 向缓冲区中添加item-&gt;valuestring</span></span><br><span class="line">    <span class="keyword">return</span> print_string_ptr(item-&gt;valuestring, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">print_string_ptr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str, printbuffer *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ptr;</span><br><span class="line">    <span class="keyword">char</span> *ptr2, *out;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>, flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> token;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (ptr = str; *ptr; ptr++) &#123;</span><br><span class="line">        flag |= ((*ptr &gt; <span class="number">0</span> &amp;&amp; *ptr &lt; <span class="number">32</span>) || (*ptr == <span class="string">'\"'</span>) || (*ptr == <span class="string">'\\'</span>)) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">        <span class="comment">/* 如果str不含0-32的特殊指令字符 或 " 或 \ 则直接处理 */</span></span><br><span class="line">        len = ptr - str; <span class="comment">// 截取这一段"合法"的字符串[str, ptr]</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*如果缓冲区有数据，在后面预设len + 3("xxxx"\0)的缓冲区大小，并且out为指向缓冲区的末尾待添加处的指针*/</span></span><br><span class="line">        <span class="keyword">if</span> (p) out = ensure(p, len + <span class="number">3</span>);</span><br><span class="line">        <span class="comment">/*否则直接申请空间*/</span></span><br><span class="line">        <span class="keyword">else</span> out = (<span class="keyword">char</span>*)cJSON_malloc(len + <span class="number">3</span>);</span><br><span class="line">        <span class="keyword">if</span> (!out) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 申请失败，返回0</span></span><br><span class="line">        ptr2 = out; </span><br><span class="line">        <span class="comment">// 在该指针位置添加字符串，格式为"xxx"</span></span><br><span class="line">        *ptr2++ = <span class="string">'\"'</span>;</span><br><span class="line">        <span class="built_in">strcpy</span>(ptr2, str);</span><br><span class="line">        ptr2[len] = <span class="string">'\"'</span>;</span><br><span class="line">        ptr2[len + <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> out; <span class="comment">// 返回了添加字符串的头指针</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!str) &#123;</span><br><span class="line">        <span class="comment">// 如果字符串为空</span></span><br><span class="line">        <span class="keyword">if</span> (p) out = ensure(p, <span class="number">3</span>);</span><br><span class="line">        <span class="keyword">else</span> out = (<span class="keyword">char</span>*)cJSON_malloc(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">if</span> (!out) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">strcpy</span>(out, <span class="string">"\"\""</span>); <span class="comment">// out为""</span></span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*开始处理含转义字符的接下来部分*/</span></span><br><span class="line">    ptr = str; <span class="comment">// ptr重定位到str的开头处</span></span><br><span class="line">    <span class="comment">/* 遍历该段字符串到结尾*/</span></span><br><span class="line">    <span class="keyword">while</span> ((token = *ptr) &amp;&amp; ++len) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strchr</span>(<span class="string">"\"\\\b\f\n\r\t"</span>, token))</span><br><span class="line">            <span class="comment">// 如果遍历到的字符token中包含有" \ \b \f \n \r \t，则len自增1</span></span><br><span class="line">            len++;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (token &lt; <span class="number">32</span>)</span><br><span class="line">            <span class="comment">// 如果不包含有转义字符，且token为一控制字符（ascii为1-32），len自增5</span></span><br><span class="line">            len += <span class="number">5</span>;</span><br><span class="line">        ptr++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// len + 3表示字符串两侧套上"并加入\0</span></span><br><span class="line">	<span class="keyword">if</span> (p)	out = ensure(p, len + <span class="number">3</span>);</span><br><span class="line">	<span class="keyword">else</span>	out = (<span class="keyword">char</span>*)cJSON_malloc(len + <span class="number">3</span>);</span><br><span class="line">	<span class="keyword">if</span> (!out) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ptr2为输出内容的头指针</span></span><br><span class="line">    <span class="comment">// ptr为str的头指针</span></span><br><span class="line">    ptr2 = out; ptr = str;</span><br><span class="line">    *ptr2++ = <span class="string">'\"'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (*ptr) &#123;</span><br><span class="line">        <span class="comment">// 再次遍历这段字符串内容</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">char</span>)*ptr &gt; <span class="number">31</span> &amp;&amp; *ptr != <span class="string">'\"'</span> &amp;&amp; *ptr != <span class="string">'\\'</span>)</span><br><span class="line">        	<span class="comment">// 如果该字符不涉及转义和操作字符等内容，直接粘贴</span></span><br><span class="line">            *ptr2++ = *ptr++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *ptr2++ = <span class="string">'\\'</span>;</span><br><span class="line">        <span class="keyword">switch</span>(token = *ptr++) &#123;</span><br><span class="line">        	<span class="comment">// 分类讨论转义字符的情况</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\\'</span>:  *ptr2++ = <span class="string">'\\'</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\"'</span>:	*ptr2++ = <span class="string">'\"'</span>;	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\b'</span>:	*ptr2++ = <span class="string">'b'</span>;	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\f'</span>:	*ptr2++ = <span class="string">'f'</span>;	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\n'</span>:	*ptr2++ = <span class="string">'n'</span>;	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\r'</span>:	*ptr2++ = <span class="string">'r'</span>;	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'\t'</span>:	*ptr2++ = <span class="string">'t'</span>;	<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *ptr2++ = <span class="string">'\"'</span>;</span><br><span class="line">    *ptr2++ = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="print-array-函数"><a href="#print-array-函数" class="headerlink" title="print_array()函数"></a><code>print_array()</code>函数</h5><p><code>array</code>是由一个一个的<code>item</code>组成的，故对于其每一个<code>item</code>都需要在<code>printbuffer</code>中预留额外的空间。</p>
<p><code>fmt</code>很可能是指示了元素和逗号之间是否有空格。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*输出序列，顺序输出即可（中间添加逗号，根据格式添加space）*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">print_array</span><span class="params">(cJSON* item, <span class="keyword">int</span> depth, <span class="keyword">int</span> fmt, printbuffer *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> **entries;</span><br><span class="line">    <span class="keyword">char</span> *out = <span class="number">0</span>, *ptr, *ret;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">5</span>; <span class="comment">/*len最小为5 [\"\"]\0*/</span></span><br><span class="line">    cJSON *child = item-&gt;child; <span class="comment">// 由于输出的是array需要child</span></span><br><span class="line">    <span class="keyword">int</span> numentries = <span class="number">0</span>, i = <span class="number">0</span>, fail = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> tmplen = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// child个数对应了序列中元素个数多少</span></span><br><span class="line">    <span class="keyword">while</span> (child) &#123;</span><br><span class="line">        numentries++;</span><br><span class="line">        child = child-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!numentries) &#123;</span><br><span class="line">        <span class="comment">// 若序列为空</span></span><br><span class="line">        <span class="keyword">if</span> (p) out = ensure(p, <span class="number">3</span>);</span><br><span class="line">        <span class="keyword">else</span> out = (<span class="keyword">char</span>*)cJSON_malloc(c);</span><br><span class="line">        <span class="keyword">if</span> (out) <span class="built_in">strcpy</span>(out, <span class="string">"[]"</span>);</span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (p) &#123;</span><br><span class="line">        <span class="comment">/* 组成输出序列 */</span></span><br><span class="line">        i = p-&gt;offset;</span><br><span class="line">        ptr = ensure(p, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (!ptr) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        *ptr = <span class="string">'['</span>;</span><br><span class="line">        p-&gt;offset++;</span><br><span class="line">        child = item-&gt;child;</span><br><span class="line">        <span class="keyword">while</span> (child &amp;&amp; !fail) &#123;</span><br><span class="line">            print_value(child, depth + <span class="number">1</span>, fmt, p);</span><br><span class="line">            p-&gt;offset = update(p);</span><br><span class="line">            <span class="keyword">if</span> (child-&gt;next) &#123;</span><br><span class="line">                <span class="comment">// null -&gt; len = 1 !null -&gt; len = 2</span></span><br><span class="line">                len = fmt ? <span class="number">2</span> : <span class="number">1</span>; </span><br><span class="line">                ptr = ensure(p, len + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (!ptr) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                *ptr++ = <span class="string">','</span>;</span><br><span class="line">                <span class="keyword">if</span> (fmt) *ptr++ = <span class="string">' '</span>; <span class="comment">// fmt决定了元素间是否有空格</span></span><br><span class="line">                *ptr = <span class="number">0</span>;</span><br><span class="line">                p-&gt;offset += len;</span><br><span class="line">            &#125;</span><br><span class="line">            child = child-&gt;next;</span><br><span class="line">            ptr = ensure(p, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span> (!ptr) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            *ptr++ = <span class="string">']'</span>;</span><br><span class="line">            *ptr = <span class="number">0</span>;</span><br><span class="line">            out = (p-&gt;<span class="built_in">buffer</span>) + i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* 分配一个序列来承载每个值 */</span></span><br><span class="line">        entries = (<span class="keyword">char</span>**)cJSON_malloc(numentries * <span class="keyword">sizeof</span>(<span class="keyword">char</span>*));</span><br><span class="line">        <span class="keyword">if</span> (!entries) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">memset</span>(entries, <span class="number">0</span>, numentries * <span class="keyword">sizeof</span>(<span class="keyword">char</span>*));</span><br><span class="line">        <span class="comment">/* 检查所有结果 */</span></span><br><span class="line">        child = item-&gt;child;</span><br><span class="line">        <span class="keyword">while</span> (child &amp;&amp; !fail) &#123;</span><br><span class="line">            ret = print_value(child, depth + <span class="number">1</span>, fmt, <span class="number">0</span>);</span><br><span class="line">            entries[i++] = ret;</span><br><span class="line">            <span class="keyword">if</span> (ret) len += <span class="built_in">strlen</span>(ret) + <span class="number">2</span> + (fmt ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">else</span> fail = <span class="number">1</span>;</span><br><span class="line">            child = child-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!fail) out = (*<span class="keyword">char</span>)cJSON_malloc(len);</span><br><span class="line">        <span class="keyword">if</span> (!out) fail = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (fail) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numentries; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (entries[i])</span><br><span class="line">                    <span class="comment">// 删除要把每个item都删掉</span></span><br><span class="line">                    cJSON_free(entries[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            cJSON_free(entries);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        *out = <span class="string">'['</span>;</span><br><span class="line">        ptr = out + <span class="number">1</span>;</span><br><span class="line">        *ptr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numentries; ++i) &#123;</span><br><span class="line">            <span class="comment">// 边遍历entries边将其转移合并到ptr指向的内容，并在过程中free(entries)。</span></span><br><span class="line">            tmplen = <span class="built_in">strlen</span>(entries[i]);</span><br><span class="line">            <span class="built_in">memcpy</span>(ptr, entries[i], tmplen);</span><br><span class="line">            ptr += tmplen;</span><br><span class="line">            <span class="keyword">if</span> (i != numentries - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// 中间加逗号</span></span><br><span class="line">                *ptr++ = <span class="string">','</span>;</span><br><span class="line">                <span class="keyword">if</span> (fmt) *ptr++ = <span class="string">' '</span>;</span><br><span class="line">                *ptr = <span class="number">0</span>;               </span><br><span class="line">            &#125;</span><br><span class="line">            cJSON_free(entries[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        cJSON_free(entries);</span><br><span class="line">        *ptr++ = <span class="string">']'</span>;</span><br><span class="line">        *ptr+= = <span class="number">0</span>;        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> out;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="print-object-函数"><a href="#print-object-函数" class="headerlink" title="print_object()函数"></a><code>print_object()</code>函数</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*输出对象，每个key之间要有空行*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">print_object</span><span class="params">(cJSON *item, <span class="keyword">int</span> depth, <span class="keyword">int</span> fmt, printbuffer *p)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*fmt代表了中间是否有换行/缩进 1有0无*/</span></span><br><span class="line">    <span class="comment">/*depth代表第几个制表符位置(行中的相对位置)*/</span></span><br><span class="line">    <span class="keyword">char</span> **entries = <span class="number">0</span>, **names = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *out = <span class="number">0</span>, *ptr, *ret, *str;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">7</span>, i = <span class="number">0</span>, j;</span><br><span class="line">    cJSON *child = item-&gt;child;</span><br><span class="line">    <span class="keyword">int</span> numentries = <span class="number">0</span>, fail = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> tmplen = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (child) &#123;</span><br><span class="line">        numentries++;</span><br><span class="line">        child = child-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!numentries) &#123; <span class="comment">// 如果对象为空</span></span><br><span class="line">        <span class="comment">// depth+4 ... &#123;\n(depth - 1)*(\t)&#125;\0</span></span><br><span class="line">        <span class="comment">// 3       ... &#123;&#125;\0</span></span><br><span class="line">        <span class="keyword">if</span> (p) out = ensure(p, fmt ? depth + <span class="number">4</span> : <span class="number">3</span>);</span><br><span class="line">        <span class="comment">// 如果fmt为1 说明要进行空行</span></span><br><span class="line">        <span class="keyword">else</span> out = (<span class="keyword">char</span>*)cJSON_malloc(fmt ? depth + <span class="number">4</span> : );</span><br><span class="line">        <span class="keyword">if</span> (!out) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        ptr = out;</span><br><span class="line">        *ptr++ = <span class="string">'&#123;'</span>;</span><br><span class="line">        <span class="keyword">if</span> (fmt) &#123;</span><br><span class="line">            *ptr++ = <span class="string">'\n'</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; depth - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">                *ptr++ = <span class="string">'\t'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        *ptr++ = <span class="string">'&#125;'</span>;</span><br><span class="line">        *ptr++ = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (p) &#123;</span><br><span class="line">        <span class="comment">// 如果输出buffer不为空，组成输出</span></span><br><span class="line">        i = p-&gt;offset;</span><br><span class="line">        len = fmt ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">        ptr = ensure(p, len + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (!ptr) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        *ptr++ = <span class="string">'&#123;'</span>;</span><br><span class="line">        <span class="keyword">if</span> (fmt) *ptr++ = <span class="string">'\n'</span>;</span><br><span class="line">        *ptr = <span class="number">0</span>;</span><br><span class="line">        p-&gt;offset += len;</span><br><span class="line">        child = item-&gt;child;</span><br><span class="line">        depth++;</span><br><span class="line">        <span class="keyword">while</span> (child) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fmt) &#123;</span><br><span class="line">                ptr = ensure(p, depth);</span><br><span class="line">                <span class="keyword">if</span> (!ptr) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; depth; ++j) &#123;</span><br><span class="line">                    *ptr++ = <span class="string">'\t'</span>; <span class="comment">// ptr后添加depth个\t</span></span><br><span class="line">                &#125;</span><br><span class="line">                p-&gt;offset += depth;</span><br><span class="line">            &#125;</span><br><span class="line">            print_string_ptr(child-&gt;<span class="built_in">string</span>, p); <span class="comment">// key一定是字符串格式</span></span><br><span class="line">            p-&gt;offset += update(p);</span><br><span class="line">            </span><br><span class="line">            len = fmt ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">            ptr = ensure(p, len);</span><br><span class="line">            <span class="keyword">if</span> (!ptr) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            *ptr++ = <span class="string">':'</span>;</span><br><span class="line">            <span class="keyword">if</span> (fmt) *ptr++ = <span class="string">'\t'</span>;</span><br><span class="line">            p-&gt;offset += len;</span><br><span class="line">            </span><br><span class="line">            print_value(child, depth, fmt, p); <span class="comment">// val需要依据其数据类型而定</span></span><br><span class="line">            p-&gt;offset = update(p);</span><br><span class="line">            </span><br><span class="line">            len = (fmt ? <span class="number">1</span> : <span class="number">0</span>) + (child-&gt;next ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">            ptr = ensure(p, len + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (!ptr) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (child-&gt;next) *ptr++ = <span class="string">','</span>;</span><br><span class="line">            <span class="keyword">if</span> (fmt) *ptr++ = <span class="string">'\n'</span>;</span><br><span class="line">            *ptr = <span class="number">0</span>;</span><br><span class="line">            p-&gt;offset += len;</span><br><span class="line">            </span><br><span class="line">            child = child-&gt;next;           </span><br><span class="line">        &#125;</span><br><span class="line">        ptr = ensure(p, fmt ? (depth + <span class="number">1</span>) : <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (!ptr) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (fmt) &#123;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; depth - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">                *ptr++ = <span class="string">'\t'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        *ptr++ = <span class="string">'&#125;'</span>;</span><br><span class="line">        *ptr = <span class="number">0</span>;</span><br><span class="line">        out = (p-&gt;<span class="built_in">buffer</span>) + i;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* 如果输出buffer为空，为对象名和对象分配空间 */</span></span><br><span class="line">        entries = (<span class="keyword">char</span>**)cJSON_malloc(numentries * <span class="keyword">sizeof</span>(<span class="keyword">char</span>*));</span><br><span class="line">        <span class="keyword">if</span> (!entries) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        names = (<span class="keyword">char</span>**)cJSON_malloc(numentries * <span class="keyword">sizeof</span>(<span class="keyword">char</span>*));</span><br><span class="line">        <span class="keyword">if</span> (!names) &#123;cJSON_free(entries); <span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">        <span class="built_in">memset</span>(entries, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">char</span>*) * numentries);</span><br><span class="line">        <span class="built_in">memset</span>(names, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">char</span>*) * numentries);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 将所有结果放入数组中 */</span></span><br><span class="line">        child = item-&gt;child;</span><br><span class="line">        depth++;</span><br><span class="line">        <span class="keyword">if</span> (fmt) len += depth;</span><br><span class="line">        <span class="keyword">while</span> (child) &#123;</span><br><span class="line">            names[i] = str = print_string_ptr(child-&gt;<span class="built_in">string</span>, <span class="number">0</span>);</span><br><span class="line">            entries[i++] = ret = print_value(child, depth, fmt, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str &amp;&amp; ret) len += <span class="built_in">strlen</span>(ret) + <span class="built_in">strlen</span>(str) + <span class="number">2</span> + (fmt ? <span class="number">2</span> + depth : <span class="number">0</span>); </span><br><span class="line">            <span class="comment">// name + 2("") + 2 + depth(2是:两侧的空格)</span></span><br><span class="line">            <span class="keyword">else</span> fail = <span class="number">1</span>;</span><br><span class="line">            </span><br><span class="line">            child = child-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!fail) out = (<span class="keyword">char</span>*)cJSON_malloc(len);</span><br><span class="line">        <span class="keyword">if</span> (!out) fail = <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (fail) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numentries; ++i) &#123;</span><br><span class="line">                <span class="comment">// 逐个free掉names[i]和entries[i]</span></span><br><span class="line">                <span class="keyword">if</span> (names[i]) &#123;</span><br><span class="line">                    cJSON_free(names[i]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (entries[i]) &#123;</span><br><span class="line">                    cJSON_free(entries[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            cJSON_free(names[i]); </span><br><span class="line">            cJSON_free(entries[i]);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        *out = <span class="string">'&#123;'</span>;</span><br><span class="line">        ptr = out + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (fmt) *ptr++ = <span class="string">'\n'</span>;</span><br><span class="line">        *ptr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; numentries; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fmt) &#123;</span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; depth; ++j) &#123;</span><br><span class="line">                    *ptr++ = <span class="string">'\t'</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            tmplen = <span class="built_in">strlen</span>(names[i]);</span><br><span class="line">            <span class="comment">// 这里为啥不用strcpy</span></span><br><span class="line">            <span class="built_in">memcpy</span>(ptr, names[i], tmplen);</span><br><span class="line">            ptr += tmplen;</span><br><span class="line">            *ptr++ = <span class="string">':'</span>;</span><br><span class="line">            <span class="keyword">if</span> (fmt) *ptr++ = <span class="string">'\t'</span>;</span><br><span class="line">            <span class="built_in">strcpy</span>(ptr, entries[i]);</span><br><span class="line">            ptr += <span class="built_in">strlen</span>(entries[i]);</span><br><span class="line">            <span class="keyword">if</span> (i != numentries - <span class="number">1</span>) *ptr++ = <span class="string">','</span>;</span><br><span class="line">            <span class="keyword">if</span> (fmt) *ptr++ = <span class="string">'\n'</span>;</span><br><span class="line">            *ptr = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 边转移到输出边free</span></span><br><span class="line">            cJSON_free(names);</span><br><span class="line">            cJSON(entries[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        cJSON_free(names); cJSON_free(entries);</span><br><span class="line">        <span class="keyword">if</span> (fmt) </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; depth - <span class="number">1</span>; ++i)</span><br><span class="line">                *ptr++ = <span class="string">'\t'</span>;</span><br><span class="line">        *ptr = <span class="string">'&#125;'</span>; *ptr++ = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">cJSON_GetErrorPtr</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;<span class="keyword">return</span> ep;&#125; <span class="comment">// 获取错误类型指针</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 字符串比较函数</span></span><br><span class="line"><span class="comment">	如果s1 == s2，返回0</span></span><br><span class="line"><span class="comment">	如果s1 &gt; s2，返回正数</span></span><br><span class="line"><span class="comment">	如果s1 &lt; s2，返回负数 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">cJSON_strcasecmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s1, <span class="keyword">const</span> <span class="keyword">char</span> *s2)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!s1) <span class="keyword">return</span> (s1 == s2) ? <span class="number">0</span> : <span class="number">1</span>; <span class="comment">// s1 == s2 == nullptr</span></span><br><span class="line">    <span class="keyword">if</span> (!s2) <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// s1 != nullptr s2 == nullptr</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (; <span class="built_in">tolower</span>(*s1) == <span class="built_in">tolower</span>(*s2); ++s1, ++s2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (*s1 == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// s1与s2完全相等</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">tolower</span>(*(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)s1) - <span class="built_in">tolower</span>(*(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)s2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 复制字符串 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span>* <span class="title">cJSON_strdup</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* copy;</span><br><span class="line">    </span><br><span class="line">    len = <span class="built_in">strlen</span>(str) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (!(copy = (*<span class="keyword">char</span>)cJSON_malloc(len)))</span><br><span class="line">        <span class="comment">// 如果对copy申请空间失败，返回0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(copy, str, len);</span><br><span class="line">    <span class="keyword">return</span> copy; <span class="comment">// 返回副本</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 内部构造函数(初始化) */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> cJSON *<span class="title">cJSON_New_Item</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    cJSON* node = (cJSON*)cJSON_malloc(<span class="keyword">sizeof</span>(cJSON));</span><br><span class="line">    <span class="keyword">if</span> (node) <span class="built_in">memset</span>(node, <span class="number">0</span>, <span class="keyword">sizeof</span>(cJSON));</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 删除一个cJSON结构 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_Delete</span><span class="params">(cJSON *c)</span> </span>&#123;</span><br><span class="line">    cJSON *next;</span><br><span class="line">    <span class="keyword">while</span> (c) &#123;</span><br><span class="line">        next = c-&gt;next; <span class="comment">// next承接下一个内容</span></span><br><span class="line">        <span class="comment">// cJSON_IsReference 256    100000000</span></span><br><span class="line">        <span class="comment">// cJSON_StringIsConst 512 1000000000</span></span><br><span class="line">        <span class="comment">/* c-&gt;type不能是256和512 */</span></span><br><span class="line">        <span class="keyword">if</span> (!(c-&gt;type &amp; cJSON_IsReference) &amp;&amp; c-&gt;child) cJSON_Delete(c-&gt;child); <span class="comment">// 递归free掉孩子节点</span></span><br><span class="line">        <span class="keyword">if</span> (!(c-&gt;type &amp; cJSON_IsReference) &amp;&amp; c-&gt;valuestring) cJSON_free(c-&gt;valuestring); <span class="comment">// free掉valuestring</span></span><br><span class="line">        <span class="keyword">if</span> (!(c-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; c-&gt;<span class="built_in">string</span>) cJSON_free(c-&gt;<span class="built_in">string</span>); <span class="comment">// free掉string</span></span><br><span class="line">        cJSON_free(c); <span class="comment">// free掉前一个结点</span></span><br><span class="line">        c = next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 返回一个比x-1大的最小的2^N */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pow2gt</span> <span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    --x;</span><br><span class="line">    <span class="comment">// 10010 </span></span><br><span class="line">    <span class="comment">// 01001 1 11011</span></span><br><span class="line">    <span class="comment">// 00100 2 11111</span></span><br><span class="line">    <span class="comment">// 00001 4 11111 --&gt; 31 + 1 = 32</span></span><br><span class="line">    x |= x &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    x |= x &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> x + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 用于将json数据打印到缓冲区时，提供缓存空间的信息 */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *<span class="built_in">buffer</span>; <span class="comment">// 缓存地址指针</span></span><br><span class="line">    <span class="keyword">int</span> length; <span class="comment">// 缓存当前缓存区长度</span></span><br><span class="line">    <span class="keyword">int</span> offset; <span class="comment">// 缓存当前已经使用过的位置（偏移量）</span></span><br><span class="line">&#125; printbuffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 确保p所指向的缓冲区能够提供needed大小的缓冲给打印功能使用 */</span></span><br><span class="line"><span class="comment">/* 返回缓冲区可以继续使用的空间位置指针 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span>* <span class="title">ensure</span><span class="params">(printbuffer *p, <span class="keyword">int</span> needed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *newbuffer;</span><br><span class="line">    <span class="keyword">int</span> newsize;</span><br><span class="line">    <span class="keyword">if</span> (!p || !p-&gt;<span class="built_in">buffer</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    needed += p-&gt;offset; <span class="comment">// 更新needed为原使用过长度+需要长度</span></span><br><span class="line">    <span class="keyword">if</span> (needed &lt;= p-&gt;length) <span class="keyword">return</span> p-&gt;<span class="built_in">buffer</span> + p-&gt;offset; <span class="comment">// 如果缓冲区的大小足够用，直接返回</span></span><br><span class="line">    </span><br><span class="line">    newsize = pow2gt(needed); <span class="comment">// newsize为比needed大的最小的2次幂数</span></span><br><span class="line">    newbuffer = (<span class="keyword">char</span> *)cJSON_malloc(newsize);</span><br><span class="line">    <span class="keyword">if</span> (!newbuffer) &#123;</span><br><span class="line">        cJSON_free(p-&gt;<span class="built_in">buffer</span>);</span><br><span class="line">        p-&gt;length = <span class="number">0</span>, p-&gt;<span class="built_in">buffer</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newbuffer) &#123;</span><br><span class="line">        <span class="comment">// 将原缓存区中的缓存区的全部内容复制到newbuffer</span></span><br><span class="line">        <span class="built_in">memcpy</span>(newbuffer, p-&gt;<span class="built_in">buffer</span>, p-&gt;length);</span><br><span class="line">    &#125;</span><br><span class="line">    cJSON_free(p-&gt;<span class="built_in">buffer</span>);</span><br><span class="line">    p-&gt;length = newsize;</span><br><span class="line">    p-&gt;<span class="built_in">buffer</span> = newbuffer;</span><br><span class="line">    <span class="keyword">return</span> newbuffer + p-&gt;offset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 将待缓存结构更新到缓存区，并返回已使用的内存大小 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(printbuffer *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *str;</span><br><span class="line">    <span class="keyword">if</span> (!p || !p-&gt;<span class="built_in">buffer</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    str = p-&gt;<span class="built_in">buffer</span> + p-&gt;offset;</span><br><span class="line">    <span class="keyword">return</span> p-&gt;offset + <span class="built_in">strlen</span>(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下大部分为呼应.h文件中的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cJSON_GetArraySize</span><span class="params">(cJSON *<span class="built_in">array</span>)</span> </span>&#123;</span><br><span class="line">    cJSON *c = <span class="built_in">array</span>-&gt;child;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (c) &#123;</span><br><span class="line">        ++i;</span><br><span class="line">        c = c-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_GetArrayItem</span><span class="params">(cJSON *<span class="built_in">array</span>, <span class="keyword">int</span> item)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// get第item个元素节点</span></span><br><span class="line">    cJSON *c = <span class="built_in">array</span>-&gt;child;</span><br><span class="line">    <span class="keyword">while</span> (c &amp;&amp; item &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        item--;</span><br><span class="line">        c = c-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_GetObjectItem</span><span class="params">(cJSON *object, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// get值为string的元素节点</span></span><br><span class="line">    cJSON *c = object-&gt;child;</span><br><span class="line">    <span class="keyword">while</span> (c &amp;&amp; cJSON_strcasecmp(c-&gt;<span class="built_in">string</span>, <span class="built_in">string</span>)) c = c-&gt;next;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 双向链表的节点插入操作 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">suffix_object</span><span class="params">(cJSON *prev, cJSON *item)</span> </span>&#123;</span><br><span class="line">    prev-&gt;next = item;</span><br><span class="line">    item-&gt;prev = prev;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">static</span> cJSON *<span class="title">create_reference</span><span class="params">(cJSON *item)</span> </span>&#123;</span><br><span class="line">    cJSON *ref = cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span> (!ref) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(ref, item, <span class="keyword">sizeof</span>(cJSON));</span><br><span class="line">    ref-&gt;<span class="built_in">string</span> = <span class="number">0</span>;</span><br><span class="line">    ref-&gt;type |= cJSON_IsReference;</span><br><span class="line">    ref-&gt;next = ref-&gt;prev = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> ref;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_AddItemToArray</span><span class="params">(cJSON *<span class="built_in">array</span>, cJSON *item)</span> </span>&#123;</span><br><span class="line">    cJSON *c = <span class="built_in">array</span>-&gt;child;</span><br><span class="line">    <span class="keyword">if</span> (!item) <span class="keyword">return</span>; </span><br><span class="line">    <span class="keyword">if</span> (!c) &#123;<span class="built_in">array</span>-&gt;child = item;&#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (c &amp;&amp; c-&gt;next) c = c-&gt;next; </span><br><span class="line">        suffix_object(c, item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_AddItemToObject</span><span class="params">(cJSON *object, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>, cJSON *item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!item) <span class="keyword">return</span>; </span><br><span class="line">    <span class="keyword">if</span> (item-&gt;<span class="built_in">string</span>) cJSON_free(item-&gt;<span class="built_in">string</span>);</span><br><span class="line">    item-&gt;<span class="built_in">string</span> = cJSON_strdup(<span class="built_in">string</span>);</span><br><span class="line">    cJSON_AddItemToArray(object,item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_AddItemToObjectCS</span><span class="params">(cJSON *object, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>, cJSON *item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!item) <span class="keyword">return</span>; </span><br><span class="line">    <span class="keyword">if</span> (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; item-&gt;<span class="built_in">string</span>) cJSON_free(item-&gt;<span class="built_in">string</span>);</span><br><span class="line">    item-&gt;<span class="built_in">string</span> = (<span class="keyword">char</span>*)<span class="built_in">string</span>;</span><br><span class="line">    item-&gt;type |= cJSON_StringIsConst;</span><br><span class="line">    cJSON_AddItemToArray(object, item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_AddItemReferenceToArray</span><span class="params">(cJSON *<span class="built_in">array</span>, cJSON *item)</span> </span>&#123;</span><br><span class="line">    cJSON_AddItemToArray(<span class="built_in">array</span>,create_reference(item));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_AddItemReferenceToObject</span><span class="params">(cJSON *object, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>, cJSON *item)</span> </span>&#123;</span><br><span class="line">    cJSON_AddItemToObject(object,<span class="built_in">string</span>,create_reference(item));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 从Array中分离第which个元素，并将该元素返回 */</span></span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_DetachItemFromArray</span><span class="params">(cJSON *<span class="built_in">array</span>, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">    cJSON *c = <span class="built_in">array</span>-&gt;child;</span><br><span class="line">    <span class="keyword">while</span> (c &amp;&amp; which &gt; <span class="number">0</span>) c = c-&gt;next, which--;</span><br><span class="line">    <span class="keyword">if</span> (!c) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 调整双向链表的前驱和后驱节点的后驱和前驱指向</span></span><br><span class="line">	<span class="keyword">if</span> (c-&gt;prev) c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;next) c-&gt;next-&gt;prev = c-&gt;prev;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="built_in">array</span>-&gt;child) <span class="built_in">array</span>-&gt;child = c-&gt;next; <span class="comment">// 如果which == 0，只需要更新array-&gt;child</span></span><br><span class="line">    c-&gt;prev = c-&gt;next = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_DeleteItemFromArray</span><span class="params">(cJSON *<span class="built_in">array</span>, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">    cJSON_Delete(cJSON_DetachItemFromArray(<span class="built_in">array</span>, which));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_DetachItemFromObject</span><span class="params">(cJSON *object, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    cJSON *c = object-&gt;child;</span><br><span class="line">    <span class="keyword">while</span> (c &amp;&amp; cJSON_strcasecmp(c-&gt;<span class="built_in">string</span>, <span class="built_in">string</span>))</span><br><span class="line">        ++i, c = c-&gt;next;</span><br><span class="line">    <span class="keyword">if</span> (c) <span class="keyword">return</span> cJSON_DetachItemFromArray(object, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_DeleteItemFromObject</span><span class="params">(cJSON *object, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>)</span> </span>&#123;</span><br><span class="line">    cJSON_Delete(cJSON_DetachItemFromObject(object, <span class="built_in">string</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*向array或object中添加或替代元素*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_InsertItemInArray</span><span class="params">(cJSON *<span class="built_in">array</span>, <span class="keyword">int</span> which, cJSON *newitem)</span> </span>&#123;</span><br><span class="line">    cJSON *c = <span class="built_in">array</span>-&gt;child;</span><br><span class="line">    <span class="keyword">while</span> (c &amp;&amp; which &gt; <span class="number">0</span>) c = c-&gt;next, which--;</span><br><span class="line">    <span class="keyword">if</span> (!c) &#123;cJSON_AddItemToArray(<span class="built_in">array</span>, newitem); <span class="keyword">return</span>;&#125; <span class="comment">// 如果array为空，直接添加</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    b -&gt; c</span></span><br><span class="line"><span class="comment">    变成</span></span><br><span class="line"><span class="comment">    b -&gt; newitem -&gt; c</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	newitem-&gt;next = c;</span><br><span class="line">    newitem-&gt;prev = c-&gt;prev;</span><br><span class="line">    c-&gt;prev = newitem;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="built_in">array</span>-&gt;child) <span class="built_in">array</span>-&gt;child = newitem; </span><br><span class="line">    <span class="keyword">else</span> newitem-&gt;prev-&gt;next = newitem; <span class="comment">// 如果存在前驱节点，让他指向newitem</span></span><br><span class="line">&#125;</span><br><span class="line">                                   </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_ReplaceItemInArray</span><span class="params">(cJSON *<span class="built_in">array</span>,<span class="keyword">int</span> which,cJSON *newitem)</span> </span>&#123;</span><br><span class="line">    cJSON *c = <span class="built_in">array</span>-&gt;child;</span><br><span class="line">    <span class="keyword">while</span> (c &amp;&amp; which &gt; <span class="number">0</span>) c = c-&gt;next, which--;</span><br><span class="line">    <span class="keyword">if</span> (!c) <span class="keyword">return</span>;</span><br><span class="line">	newitem-&gt;next = c-&gt;next;</span><br><span class="line">    newitem-&gt;prev = c-&gt;prev;</span><br><span class="line">    <span class="keyword">if</span> (newitem-&gt;next) newitem-&gt;next-&gt;prev = newitem;</span><br><span class="line">	<span class="keyword">if</span> (c==<span class="built_in">array</span>-&gt;child) <span class="built_in">array</span>-&gt;child = newitem; </span><br><span class="line">    <span class="keyword">else</span> newitem-&gt;prev-&gt;next = newitem;</span><br><span class="line">    c-&gt;next=c-&gt;prev=<span class="number">0</span>;</span><br><span class="line">    cJSON_Delete(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_ReplaceItemInObject</span><span class="params">(cJSON *object,<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>,cJSON *newitem)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    cJSON *c=object-&gt;child;</span><br><span class="line">    <span class="keyword">while</span>(c &amp;&amp; cJSON_strcasecmp(c-&gt;<span class="built_in">string</span>,<span class="built_in">string</span>)) i++,c=c-&gt;next;</span><br><span class="line">    <span class="keyword">if</span>(c) &#123;</span><br><span class="line">        newitem-&gt;<span class="built_in">string</span>=cJSON_strdup(<span class="built_in">string</span>);</span><br><span class="line">        cJSON_ReplaceItemInArray(object,i,newitem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他简单函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateNull</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;cJSON *item=cJSON_New_Item();<span class="keyword">if</span>(item)item-&gt;type=cJSON_NULL;<span class="keyword">return</span> item;&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateTrue</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;cJSON *item=cJSON_New_Item();<span class="keyword">if</span>(item)item-&gt;type=cJSON_True;<span class="keyword">return</span> item;&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateFalse</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;cJSON *item=cJSON_New_Item();<span class="keyword">if</span>(item)item-&gt;type=cJSON_False;<span class="keyword">return</span> item;&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateBool</span><span class="params">(<span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    cJSON *item=cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span>(item)item-&gt;type=b?cJSON_True:cJSON_False;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*createnumber需要修改valuedouble和valueint属性*/</span></span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateNumber</span><span class="params">(<span class="keyword">double</span> num)</span> </span>&#123;</span><br><span class="line">    cJSON *item=cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span>(item) &#123;</span><br><span class="line">        item-&gt;type=cJSON_Number;</span><br><span class="line">        item-&gt;valuedouble=num;</span><br><span class="line">        item-&gt;valueint=(<span class="keyword">int</span>)num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateString</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>)</span> </span>&#123;</span><br><span class="line">    cJSON *item=cJSON_New_Item();</span><br><span class="line">    <span class="keyword">if</span>(item) &#123;</span><br><span class="line">        item-&gt;type=cJSON_String;</span><br><span class="line">        item-&gt;valuestring=cJSON_strdup(<span class="built_in">string</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateArray</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;cJSON *item=cJSON_New_Item();<span class="keyword">if</span>(item)item-&gt;type=cJSON_Array;<span class="keyword">return</span> item;&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateObject</span><span class="params">(<span class="keyword">void</span>)</span>	</span>&#123;cJSON *item=cJSON_New_Item();<span class="keyword">if</span>(item)item-&gt;type=cJSON_Object;<span class="keyword">return</span> item;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 函数都是申请数组后，对每个元素调用create函数来生成对应类型的数据 */</span></span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateIntArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> *numbers,<span class="keyword">int</span> count)</span>		</span>&#123;<span class="keyword">int</span> i;cJSON *n=<span class="number">0</span>,*p=<span class="number">0</span>,*a=cJSON_CreateArray();<span class="keyword">for</span>(i=<span class="number">0</span>;a &amp;&amp; i&lt;count;i++)&#123;n=cJSON_CreateNumber(numbers[i]);<span class="keyword">if</span>(!i)a-&gt;child=n;<span class="keyword">else</span> suffix_object(p,n);p=n;&#125;<span class="keyword">return</span> a;&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateFloatArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">float</span> *numbers,<span class="keyword">int</span> count)</span>	</span>&#123;<span class="keyword">int</span> i;cJSON *n=<span class="number">0</span>,*p=<span class="number">0</span>,*a=cJSON_CreateArray();<span class="keyword">for</span>(i=<span class="number">0</span>;a &amp;&amp; i&lt;count;i++)&#123;n=cJSON_CreateNumber(numbers[i]);<span class="keyword">if</span>(!i)a-&gt;child=n;<span class="keyword">else</span> suffix_object(p,n);p=n;&#125;<span class="keyword">return</span> a;&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateDoubleArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *numbers,<span class="keyword">int</span> count)</span>	</span>&#123;<span class="keyword">int</span> i;cJSON *n=<span class="number">0</span>,*p=<span class="number">0</span>,*a=cJSON_CreateArray();<span class="keyword">for</span>(i=<span class="number">0</span>;a &amp;&amp; i&lt;count;i++)&#123;n=cJSON_CreateNumber(numbers[i]);<span class="keyword">if</span>(!i)a-&gt;child=n;<span class="keyword">else</span> suffix_object(p,n);p=n;&#125;<span class="keyword">return</span> a;&#125;</span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_CreateStringArray</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> **strings,<span class="keyword">int</span> count)</span>	</span>&#123;<span class="keyword">int</span> i;cJSON *n=<span class="number">0</span>,*p=<span class="number">0</span>,*a=cJSON_CreateArray();<span class="keyword">for</span>(i=<span class="number">0</span>;a &amp;&amp; i&lt;count;i++)&#123;n=cJSON_CreateString(strings[i]);<span class="keyword">if</span>(!i)a-&gt;child=n;<span class="keyword">else</span> suffix_object(p,n);p=n;&#125;<span class="keyword">return</span> a;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">cJSON *<span class="title">cJSON_Duplicate</span><span class="params">(cJSON *item,<span class="keyword">int</span> recurse)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cJSON *newitem,*cptr,*nptr=<span class="number">0</span>,*newchild;</span><br><span class="line">	<span class="keyword">if</span> (!item) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	newitem = cJSON_New_Item();</span><br><span class="line">	<span class="keyword">if</span> (!newitem) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ~cJSON_IsReference 011111111</span></span><br><span class="line">    <span class="comment">// newitem-&gt;type      100000000</span></span><br><span class="line">	newitem-&gt;type = item-&gt;type &amp; (~cJSON_IsReference);</span><br><span class="line">    newitem-&gt;valueint = item-&gt;valueint;</span><br><span class="line">    newitem-&gt;valuedouble = item-&gt;valuedouble;</span><br><span class="line">	<span class="keyword">if</span> (item-&gt;valuestring) &#123;</span><br><span class="line">        newitem-&gt;valuestring = cJSON_strdup(item-&gt;valuestring);</span><br><span class="line">        <span class="keyword">if</span> (!newitem-&gt;valuestring) &#123;cJSON_Delete(newitem);<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">if</span> (item-&gt;<span class="built_in">string</span>) &#123; </span><br><span class="line">        newitem-&gt;<span class="built_in">string</span> = cJSON_strdup(item-&gt;<span class="built_in">string</span>);</span><br><span class="line">        <span class="keyword">if</span> (!newitem-&gt;<span class="built_in">string</span>) &#123;cJSON_Delete(newitem);<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">if</span> (!recurse) <span class="keyword">return</span> newitem; <span class="comment">// 没有递归的duplicate到这里就可以直接返回</span></span><br><span class="line">	cptr = item-&gt;child; <span class="comment">// 指向child节点</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">while</span> (cptr)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">// 如果item-&gt;child是array类型，需要向下next迭代执行操作</span></span><br><span class="line">		newchild=cJSON_Duplicate(cptr,<span class="number">1</span>);		<span class="comment">/* 递归向下复制 */</span></span><br><span class="line">		<span class="keyword">if</span> (!newchild) &#123;cJSON_Delete(newitem);<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">        <span class="comment">// nptr &lt;--&gt; newchild</span></span><br><span class="line">		<span class="keyword">if</span> (nptr)	&#123;nptr-&gt;next=newchild,newchild-&gt;prev=nptr;nptr=newchild;&#125;	<span class="comment">/* If newitem-&gt;child already set, then crosswire -&gt;prev and -&gt;next and move on */</span></span><br><span class="line">		<span class="keyword">else</span>		&#123;newitem-&gt;child=newchild;nptr=newchild;&#125;					<span class="comment">/* Set newitem-&gt;child and move to it */</span></span><br><span class="line">		cptr=cptr-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    以item-&gt;child-&gt;next-&gt;next的结构为例，构建完新的newitem结构如图</span></span><br><span class="line"><span class="comment">    1. newitem-&gt;newchild(nptr)</span></span><br><span class="line"><span class="comment">    2. newitem-&gt;nptr1-&gt;newchild(nptr2)</span></span><br><span class="line"><span class="comment">    ...</span></span><br><span class="line"><span class="comment">    也就是向后尾插节点</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">return</span> newitem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*跳过了几个转义字符串和注释后内容，用于将获取信息量压缩*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cJSON_Minify</span><span class="params">(<span class="keyword">char</span> *json)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *into = json;</span><br><span class="line">	<span class="keyword">while</span> (*json)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (*json == <span class="string">' '</span>) json++;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (*json == <span class="string">'\t'</span>) json++;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (*json == <span class="string">'\r'</span>) json++;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (*json == <span class="string">'\n'</span>) json++;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (*json == <span class="string">'/'</span> &amp;&amp; json[<span class="number">1</span>] == <span class="string">'/'</span>)  <span class="keyword">while</span> (*json &amp;&amp; *json != <span class="string">'\n'</span>) json++; <span class="comment">/* 双斜杠注释 */</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (*json==<span class="string">'/'</span> &amp;&amp; json[<span class="number">1</span>]==<span class="string">'*'</span>) &#123;</span><br><span class="line">            <span class="comment">/* 多行注释 */</span></span><br><span class="line">            <span class="keyword">while</span> (*json &amp;&amp; !(*json==<span class="string">'*'</span> &amp;&amp; json[<span class="number">1</span>]==<span class="string">'/'</span>)) json++; </span><br><span class="line">            json += <span class="number">2</span>; <span class="comment">// 跳过 */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (*json==<span class="string">'\"'</span>) &#123;</span><br><span class="line">            *into++ = *json++;</span><br><span class="line">            <span class="keyword">while</span> (*json &amp;&amp; *json != <span class="string">'\"'</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (*json == <span class="string">'\\'</span>) *into++ = *json++;</span><br><span class="line">                *into++ = *json++;</span><br><span class="line">            &#125;</span><br><span class="line">            *into++ = *json++;</span><br><span class="line">        &#125; <span class="comment">/* 字符串 */</span></span><br><span class="line">		<span class="keyword">else</span> *into++ = *json++;	 <span class="comment">// 剩下的所有字符</span></span><br><span class="line">	&#125;</span><br><span class="line">	*into = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="项目疑惑"><a href="#项目疑惑" class="headerlink" title="项目疑惑"></a>项目疑惑</h1><h2 id="9-10"><a href="#9-10" class="headerlink" title="9.10"></a>9.10</h2><ul>
<li><p><code>print_number</code>函数，if语句的前两种情况不明白为什么要开2和21的空间大小。</p>
</li>
<li><p>类型的宏定义应该定义的是右移的位数？</p>
</li>
</ul>
<h2 id="9-12"><a href="#9-12" class="headerlink" title="9.12"></a>9.12</h2><ul>
<li><p><code>pow2gt()</code>求比needed大的最小2次幂数有什么用</p>
</li>
<li><p><code>print_string</code>函数，转义字符那段没看懂，为什么将<code>\b</code>-&gt;<code>b</code>？</p>
</li>
<li><p><code>depth</code>和<code>fmt</code>这两个参数没有搞懂</p>
<ul>
<li><strong>答：depth是在行中的相对位置，fmt是是否格式化的标志</strong></li>
</ul>
</li>
<li><p><code>update()</code>中，为什么不直接在原地<code>p-&gt;buffer+p-&gt;offset</code>位置之后申请<code>newsize - length</code>的空间</p>
</li>
<li><p>606行那个<code>i</code>好像有点问题（<code>fmt == 1</code>时被锁定为<code>i = depth</code>）感觉上面的for循环的循环变量不应该是i</p>
</li>
<li><p>调试的时候发现转义字符直接以”\n”类似的格式输出了，这明显是有问题的！</p>
<ul>
<li><strong>答：可能JSON格式输出的时候要求保留转义字符？</strong></li>
</ul>
</li>
</ul>
<h2 id="9-13"><a href="#9-13" class="headerlink" title="9.13"></a>9.13</h2><ul>
<li><p><code>ep</code>这个变量不知道是干啥的</p>
<ul>
<li><strong>答：错误类型的指针</strong></li>
</ul>
</li>
<li><p>utf16-&gt;utf8的原理不懂</p>
</li>
<li><p><code>PrintBuffered()</code>函数有两个return</p>
</li>
</ul>
<h2 id="9-15"><a href="#9-15" class="headerlink" title="9.15"></a>9.15</h2><ul>
<li><p>不知道<code>cJSON-&gt;valuestring</code>是干啥用的。</p>
</li>
<li><p>不知道cJSON_IsReference的具体定义到底是什么。</p>
<ul>
<li><strong>答：成员child指针或者valuestring指向的节点并不属于自己，自己仅仅是一个引用。因此，cJSON_Delete和其他相关的函数只会释放这个引用本身，而不会去释放child或者valuestring</strong></li>
</ul>
</li>
</ul>
<h2 id="9-17"><a href="#9-17" class="headerlink" title="9.17"></a>9.17</h2><ul>
<li><code>newitem-&gt;type=item-&gt;type&amp;(~cJSON_IsReference)</code>这句话不知道有什么用</li>
<li>知道<code>Minify</code>原理，不知道干啥用的</li>
</ul>
<h1 id="其他笔记"><a href="#其他笔记" class="headerlink" title="其他笔记"></a>其他笔记</h1><h2 id="大多数项目中的格式化写法"><a href="#大多数项目中的格式化写法" class="headerlink" title="大多数项目中的格式化写法"></a>大多数项目中的格式化写法</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> cJSON_h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cJSON_h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<ol>
<li><code>ifndef cJSON_h</code>这一系列是为了防止头文件被重复引用。</li>
<li><code>extern &quot;C&quot;</code>可以令这部分代码按C语言的方式进行编译。</li>
</ol>
<h2 id="static关键字的作用"><a href="#static关键字的作用" class="headerlink" title="static关键字的作用"></a>static关键字的作用</h2><p><a href="https://blog.csdn.net/gaojing303504/article/details/80346341" target="_blank" rel="noopener">参考文章</a></p>
<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><p>全局变量 -&gt; 全局<strong>静态</strong>变量</p>
<ol>
<li>内存中位置：静态存储区（在整个程序的运行期间都存在）</li>
<li>初始化：自动初始化为0</li>
<li>作用域：全局静态变量在声明他的文件之外是不可见的。准确地讲从定义之处开始到文件结尾。</li>
</ol>
<p>特点：</p>
<ol>
<li>不会被其他文件所访问和修改</li>
<li>其他文件可以使用相同名字的变量， 不会发生冲突</li>
</ol>
<h3 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h3><p>局部变量 -&gt; 局部<strong>静态</strong>变量</p>
<ul>
<li>作用域：局部作用域</li>
</ul>
<p>概括来说，局部静态变量只是改变了变量在内存中的存储位置，从原来的栈存放改为静态存储区。但是局部静态变量在离开作用域之后，并没有被销毁，而是仍然驻留在内存当中，直到程序结束，<strong>只不过我们不能再对他进行访问</strong>。</p>
<h3 id="静态函数"><a href="#静态函数" class="headerlink" title="静态函数"></a>静态函数</h3><p><strong>函数定义和声明默认情况下是extern</strong>，静态函数只是在声明他的文件中可见，不能被其他文件所用。</p>
<p>特点：其他文件可以定义相同名字的函数，无冲突</p>
<h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ul>
<li>统计函数调用次数（设置一个static类型的局部静态变量）<ul>
<li>静态函数会被自动分配在一个一直使用的存储区，直到退出应用程序实例，避免了调用函数时压栈出栈，速度快很多。</li>
</ul>
</li>
</ul>
<h2 id="strchr"><a href="#strchr" class="headerlink" title="strchr"></a>strchr</h2><p><code>char *strchr(const char *str, int c)</code>在参数<code>str</code>所指向的字符串中搜索第一次出现字符<code>c</code>的位置。</p>
<p>例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> str[] = <span class="string">"http://www.runoob.com"</span>;</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> ch = <span class="string">'.'</span>;</span><br><span class="line">   <span class="keyword">char</span> *ret;</span><br><span class="line"></span><br><span class="line">   ret = <span class="built_in">strchr</span>(str, ch);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"|%c| 之后的字符串是 - |%s|\n"</span>, ch, ret);</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回以下结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|.| 之后的字符串是 - |.runoob.com|</span><br></pre></td></tr></table></figure>



<h2 id="memcpy"><a href="#memcpy" class="headerlink" title="memcpy"></a>memcpy</h2><p><code>void *memcpy(void *str1, const void *str2, size_t n)</code> 从存储区 <strong>str2</strong> 复制 <strong>n</strong> 个字节到存储区 <strong>str1</strong></p>
<h2 id="free的模板"><a href="#free的模板" class="headerlink" title="free的模板"></a>free的模板</h2><p><a href="https://stackoverflow.com/questions/33170802/c-does-freeing-an-array-of-pointers-also-free-what-theyre-pointing-to/33170941" target="_blank" rel="noopener">参考解答</a></p>
<p>This all depends on how the array was allocated. I’ll give examples:</p>
<p>Example 1:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> <span class="built_in">array</span>[<span class="number">10</span>];</span><br><span class="line"><span class="built_in">free</span>(<span class="built_in">array</span>);     <span class="comment">// nope!</span></span><br></pre></td></tr></table></figure>

<p>Example 2:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *<span class="built_in">array</span>;</span><br><span class="line"><span class="built_in">array</span>= <span class="built_in">malloc</span>(<span class="number">10</span>);   <span class="comment">// request heap for memory</span></span><br><span class="line"><span class="built_in">free</span>(<span class="built_in">array</span>);         <span class="comment">// return to heap when no longer needed</span></span><br></pre></td></tr></table></figure>

<p>Example 3:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> **<span class="built_in">array</span>;</span><br><span class="line"><span class="built_in">array</span>= <span class="built_in">malloc</span>(<span class="number">10</span>*<span class="keyword">sizeof</span>(<span class="keyword">char</span> *));</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">array</span>[i]= <span class="built_in">malloc</span>(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">free</span>(<span class="built_in">array</span>);        <span class="comment">// nope. You should do:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">free</span>(<span class="built_in">array</span>[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">free</span>(<span class="built_in">array</span>);</span><br></pre></td></tr></table></figure>

<p>Ad. Example 1: <code>array</code> is allocated on the stack (“automatic variable”) and cannot be released by <code>free</code>. Its stack space will be released when the function returns.</p>
<p>Ad. Example 2: you request storage from the heap using <code>malloc</code>. When no longer needed, return it to the heap using <code>free</code>.</p>
<p>Ad. Example 3: you declare an array of pointers to characters. You first allocate storage for the array, then you allocate storage for each array element to place strings in. When no longer needed, you must first release the strings (with <code>free</code>) and then release the array itself (with <code>free</code>).</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a href="https://www.cnblogs.com/skullboyer/p/8152157.html" target="_blank" rel="noopener">参考1</a></p>
<p><a href="https://www.cnblogs.com/cfzhang/p/99da02ab2f02520d458c415a5314f83d.html" target="_blank" rel="noopener">参考2</a></p>
<p><a href="https://blog.csdn.net/qq_36291381/article/details/83059629" target="_blank" rel="noopener">参考3</a></p>
<p><a href="https://blog.csdn.net/zengshunyao/article/details/42461241" target="_blank" rel="noopener">DBL_EPSILON和FLT_EPSILON</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/C/" rel="tag"># C</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/09/06/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AESimple-Nes/" rel="prev" title="开源项目Simple-Nes">
      <i class="fa fa-chevron-left"></i> 开源项目Simple-Nes
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/09/08/Leetcode%E6%97%A5%E8%AE%B0VI/" rel="next" title="Leetcode日记VI">
      Leetcode日记VI <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#包含文件"><span class="nav-number">1.</span> <span class="nav-text">包含文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#文件内容"><span class="nav-number">2.</span> <span class="nav-text">文件内容</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#cJSON-h"><span class="nav-number">2.1.</span> <span class="nav-text">cJSON.h</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据类型"><span class="nav-number">2.1.1.</span> <span class="nav-text">数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据结构和其构造函数"><span class="nav-number">2.1.2.</span> <span class="nav-text">数据结构和其构造函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#函数声明"><span class="nav-number">2.1.3.</span> <span class="nav-text">函数声明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主要函数"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">主要函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#辅助函数"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">辅助函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#宏声明"><span class="nav-number">2.1.4.</span> <span class="nav-text">宏声明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cJSON-c"><span class="nav-number">2.2.</span> <span class="nav-text">cJSON.c</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#解析函数"><span class="nav-number">2.2.1.</span> <span class="nav-text">解析函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主函数"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">主函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分函数"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">分函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#parse-hex4-函数"><span class="nav-number">2.2.1.2.1.</span> <span class="nav-text">parse_hex4()函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#parse-number"><span class="nav-number">2.2.1.2.2.</span> <span class="nav-text">parse_number()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#parse-string-函数"><span class="nav-number">2.2.1.2.3.</span> <span class="nav-text">parse_string()函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#parse-object-函数"><span class="nav-number">2.2.1.2.4.</span> <span class="nav-text">parse_object()函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#输出函数"><span class="nav-number">2.2.2.</span> <span class="nav-text">输出函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#总函数"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">总函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分函数-1"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">分函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#print-number-函数"><span class="nav-number">2.2.2.2.1.</span> <span class="nav-text">print_number()函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#print-string-函数"><span class="nav-number">2.2.2.2.2.</span> <span class="nav-text">print_string()函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#print-array-函数"><span class="nav-number">2.2.2.2.3.</span> <span class="nav-text">print_array()函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#print-object-函数"><span class="nav-number">2.2.2.2.4.</span> <span class="nav-text">print_object()函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他函数"><span class="nav-number">2.2.3.</span> <span class="nav-text">其他函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#项目疑惑"><span class="nav-number">3.</span> <span class="nav-text">项目疑惑</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-10"><span class="nav-number">3.1.</span> <span class="nav-text">9.10</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-12"><span class="nav-number">3.2.</span> <span class="nav-text">9.12</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-13"><span class="nav-number">3.3.</span> <span class="nav-text">9.13</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-15"><span class="nav-number">3.4.</span> <span class="nav-text">9.15</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-17"><span class="nav-number">3.5.</span> <span class="nav-text">9.17</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#其他笔记"><span class="nav-number">4.</span> <span class="nav-text">其他笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#大多数项目中的格式化写法"><span class="nav-number">4.1.</span> <span class="nav-text">大多数项目中的格式化写法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#static关键字的作用"><span class="nav-number">4.2.</span> <span class="nav-text">static关键字的作用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#全局变量"><span class="nav-number">4.2.1.</span> <span class="nav-text">全局变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#局部变量"><span class="nav-number">4.2.2.</span> <span class="nav-text">局部变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#静态函数"><span class="nav-number">4.2.3.</span> <span class="nav-text">静态函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#功能"><span class="nav-number">4.2.4.</span> <span class="nav-text">功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#strchr"><span class="nav-number">4.3.</span> <span class="nav-text">strchr</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#memcpy"><span class="nav-number">4.4.</span> <span class="nav-text">memcpy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#free的模板"><span class="nav-number">4.5.</span> <span class="nav-text">free的模板</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考文献"><span class="nav-number">5.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Michael Johnson"
      src="/images/%E7%A8%8B%E5%BA%8F%E7%8C%BF.jpg">
  <p class="site-author-name" itemprop="name">Michael Johnson</p>
  <div class="site-description" itemprop="description">小白的个人网站</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/shmilyiris" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;shmilyiris" rel="noopener" target="_blank"><i class="我的github主页 fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Michael Johnson</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

<div class="powered-by">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <i class="fa fa-user-md"></i>
    <span id="busuanzi_container_site_uv">
        本站访客数:<span id="busuanzi_value_site_uv"></span>
    </span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_pv">
        本站访问量<span id="busuanzi_value_site_pv"></span>
    </span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : true,
      appId      : 'llRolgqGW9Ba4yUFTcxq9h8k-gzGzoHsz',
      appKey     : 'VmrmbmRVQov7ocjkzavv3vx2',
      placeholder: "欢迎各位大佬批评指正！",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
